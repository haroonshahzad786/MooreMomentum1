<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voiceflow Chat Embed</title>
  <style>
    html, body { height:100%; margin:0; }
    #vf-chat { height:100vh; width:100vw; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="vf-chat"></div>

  <script>
    // --- read ?userId= from URL so the session persists across visits
    const params = new URLSearchParams(location.search);
    const userId = params.get('userId') || ('anon-' + Math.random().toString(36).slice(2));

    // expose helpers FlutterFlow can call from WebView â†’ Evaluate JS
    window.pauseChat  = () => document.getElementById('vf-chat').classList.add('hidden');
    window.resumeChat = () => document.getElementById('vf-chat').classList.remove('hidden');

    // send events back to Flutter (WebView bridge)
    function sendToFlutter(payload) {
      const msg = JSON.stringify(payload);
      if (window.ReactNativeWebView?.postMessage) window.ReactNativeWebView.postMessage(msg);
      window.parent?.postMessage(msg, '*'); // web fallback
    }
  </script>

  <!-- Voiceflow web widget -->
  <script type="text/javascript">
    (function(d, t) {
      var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
      v.onload = function() {
        window.voiceflow.chat.load({
          verify:   { projectID: '68b9abb2a6d19e3a50b32898' }, // <-- your project
          url:      'https://general-runtime.voiceflow.com',
          versionID:'production',
          voice:    { url: 'https://runtime-api.voiceflow.com' },
          render:   { mode: 'embedded', target: document.getElementById('vf-chat') },
          autostart:true,
          user:     { id: userId } // <<< stable session key
        }).then((client) => {
          // forward Voiceflow "event" traces to FlutterFlow
          client.on('trace', (trace) => {
            if (trace?.type === 'event' && trace?.name) {
              // ex: name: "PAUSE_AND_REDIRECT", payload: { route: "Checkout" }
              sendToFlutter({ kind: 'vf:event', name: trace.name, payload: trace.payload || {} });
            }
          });
        });
      };
      v.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
      v.type = 'text/javascript';
      s.parentNode.insertBefore(v, s);
    })(document, 'script');
  </script>
</body>
</html>
